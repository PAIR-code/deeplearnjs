<script src="dist/bundle.js"></script>

<style>
  #cat {
    position: relative;
    top: 0px;
    left: 0px;   
  }

  #canvas {
    position: absolute;
    top: 0px;
    left: 0px;    
  }
</style>

<script src="https://unpkg.com/deeplearn"></script>

<img id="cat" height="416" width="416"></img>
<canvas id="canvas" height="416" width="416"></canvas>
<div id="result"></div>

<script>
  const cat = document.getElementById('cat');

  const canvasElement = document.getElementById('canvas');
  context = canvasElement.getContext('2d');
  width  = canvasElement.width;
  height = canvasElement.height;

  cat.onload = async () => {
    const resultElement = document.getElementById('result');

    resultElement.innerText = 'Loading mobilenet...';

    // If dl isn't loaded, wait 1 second.
    if (dl == null) {
      await new Promise(resolve => setTimeout(resolve, 1000));   
    }
    const math = new dl.NDArrayMathGPU();
    const mobileNet = new mobilenet.MobileNet(math);  
    await mobileNet.load();

    resultElement.innerText = 'Predicting...';

    const pixels = dl.Array3D.fromPixels(cat);

    var result = await mobileNet.predict(pixels);

    var boxes = await mobileNet.interpret_netout(result.netout);

    for (i = 0; i < boxes.length; i++) {
      box = boxes[i]

      const x = (box.x - box.w/2) * width;
      const y = (box.y - box.h/2) * height;
      const w = box.w * width;
      const h = box.h * height;

      // draw the rectangle bounding box;
      context.strokeStyle = box.getColor();
      context.lineWidth = 5;
      context.rect(x,y,w,h);
      context.stroke();   

      // draw the label and the probability
      const label = box.getLabel() + ' ' + box.getMaxProb().toFixed(2).toString();
      const font  = '24px serif';

      context.font = font;
      context.textBaseline = 'top';
      context.fillStyle = box.getColor();
      
      const textWidth = context.measureText(label).width;
      context.fillRect(x-2, y-24, textWidth, parseInt(font, 10));
      
      context.fillStyle = 'rgb(255,255,255)';
      context.fillText(label, x-2, y-24);
    }

    resultElement.innerText = 'Complete!';
  };
  cat.src = 'raccoon.jpg';
</script>
